# 3D PET å›¾åƒåˆæˆä¸åˆ†ç±»é¡¹ç›® (åŸºäº CycleGAN å’Œ 3D ResNet)

æœ¬é¡¹ç›®æ—¨åœ¨ä½¿ç”¨ CycleGAN æ¨¡å‹å®ç°ä¸¤ç§ä¸åŒ 3D PET åŒ»å­¦å½±åƒï¼ˆFDG-PET ä¸ CFT-PETï¼‰ä¹‹é—´çš„æ— ç›‘ç£å›¾åƒåˆ°å›¾åƒè½¬æ¢ã€‚æ­¤å¤–ï¼Œé¡¹ç›®è¿˜åˆ©ç”¨ç”Ÿæˆçš„ä¼ªå›¾åƒæ¥è®­ç»ƒä¸€ä¸ª 3D ResNet åˆ†ç±»å™¨ï¼Œç”¨äºä¸‹æ¸¸çš„ä¸´åºŠè¯Šæ–­ä»»åŠ¡ï¼ˆä¾‹å¦‚ï¼Œå¸•é‡‘æ£®ç—… vs. æ­£å¸¸å¯¹ç…§ï¼‰ã€‚

æ•´ä¸ªæµç¨‹ä½¿ç”¨ PyTorch æ¡†æ¶å®ç°ï¼Œå¹¶é›†æˆäº† TensorBoard è¿›è¡Œè¯¦ç»†çš„å¯è§†åŒ–ç›‘æ§ã€‚

## âœ¨ ä¸»è¦åŠŸèƒ½

- **3D CycleGAN è®­ç»ƒ**:
  - **æ¨¡å‹**: ç”Ÿæˆå™¨é‡‡ç”¨ 3D U-Net æ¶æ„ï¼Œåˆ¤åˆ«å™¨é‡‡ç”¨ 3D PatchGAN æ¶æ„ã€‚
  - **æ•°æ®é›†**: æ”¯æŒ `.nii` æ ¼å¼çš„ 3D åŒ»å­¦å½±åƒï¼Œå¹¶èƒ½æ™ºèƒ½å¤„ç†å¤æ‚çš„æ··åˆæ•°æ®é›†ï¼ˆåŒ…å«æˆå¯¹ä¸éæˆå¯¹æ ·æœ¬ï¼‰ã€‚
  - **ç›‘æ§**: å…¨ç¨‹ä½¿ç”¨ TensorBoard è®°å½•æŸå¤±å˜åŒ–å’Œå›¾åƒç”Ÿæˆæ•ˆæœï¼ˆåŒ…æ‹¬çœŸå®å›¾åƒã€ä¼ªå›¾åƒåŠè¯¯å·®å›¾ï¼‰ã€‚
  - **å­˜æ¡£**: æ¯æ¬¡è®­ç»ƒéƒ½ä¼šç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„ç‹¬ç«‹æ–‡ä»¶å¤¹ï¼Œæ•´æ´åœ°ä¿å­˜æ‰€æœ‰æ¨¡å‹æƒé‡ã€æ—¥å¿—å’Œ TensorBoard è®°å½•ã€‚

- **3D åˆ†ç±»å™¨è®­ç»ƒ**:
  - **æ¨¡å‹**: é‡‡ç”¨ 3D ResNet-18 æ¶æ„è¿›è¡Œåˆ†ç±»ã€‚
  - **æ•°æ®**: ä½¿ç”¨ CycleGAN ç”Ÿæˆçš„ä¼ªå›¾åƒä½œä¸ºè®­ç»ƒæ•°æ®ã€‚
  - **æŸå¤±å‡½æ•°**: ä½¿ç”¨ Focal Loss æ¥å¤„ç†å¯èƒ½å­˜åœ¨çš„ç±»åˆ«ä¸å¹³è¡¡é—®é¢˜ã€‚
  - **ç›‘æ§**: ä½¿ç”¨ TensorBoard è®°å½•è®­ç»ƒè¿‡ç¨‹ä¸­çš„æŸå¤±ä¸‹é™å’ŒéªŒè¯é›†å‡†ç¡®ç‡å˜åŒ–ã€‚

- **æ¨¡å—åŒ–ä»£ç **:
  - **é…ç½®**: æ‰€æœ‰è¶…å‚æ•°å‡é€šè¿‡ `options.py` ç»Ÿä¸€ç®¡ç†ï¼Œæ˜“äºè°ƒæ•´ã€‚
  - **è„šæœ¬**: åŠŸèƒ½åˆ†ç¦»ï¼Œ`trainer.py` è´Ÿè´£è®­ç»ƒï¼Œ`tester.py` è´Ÿè´£æµ‹è¯•ï¼Œ`generate_fakes.py` è´Ÿè´£ç”Ÿæˆæ•°æ®ã€‚

## ğŸ”§ ç¯å¢ƒä¸å®‰è£…

æœ¬é¡¹ç›®åŸºäº Python å’Œ PyTorchã€‚å»ºè®®æ‚¨ä½¿ç”¨ `conda` æˆ– `venv` åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿç¯å¢ƒã€‚

**1. å…‹éš†é¡¹ç›® (å¦‚æœæ‚¨å·²ä¸Šä¼ åˆ° GitHub):**
```bash
git clone [æ‚¨çš„ GitHub é¡¹ç›®é“¾æ¥]
cd [é¡¹ç›®ç›®å½•]
```

**2. å®‰è£…ä¾èµ–åº“:**
å»ºè®®åˆ›å»ºä¸€ä¸ª `requirements.txt` æ–‡ä»¶ï¼Œå¹¶å°†ä»¥ä¸‹å†…å®¹å¤åˆ¶è¿›å»ï¼Œç„¶åé€šè¿‡ `pip` å®‰è£…ã€‚

*requirements.txt:*
```
torch
torchvision
numpy
nibabel
matplotlib
tensorboard
```

é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
```bash
pip install -r requirements.txt
```

## ğŸ“‚ æ•°æ®é›†å‡†å¤‡

æœ¬é¡¹ç›®éœ€è¦ç‰¹å®šçš„ç›®å½•ç»“æ„æ¥æ­£ç¡®è§£ææˆå¯¹å’Œéæˆå¯¹æ•°æ®ã€‚è¯·åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `datasets` æ–‡ä»¶å¤¹ï¼Œå¹¶æŒ‰å¦‚ä¸‹ç»“æ„ç»„ç»‡æ‚¨çš„ `.nii` æ–‡ä»¶ï¼š

```
datasets/
â”œâ”€â”€ NC_paired_FDG+CFT/
â”‚   â”œâ”€â”€ 42632/
â”‚   â”‚   â”œâ”€â”€ ..._FDG.nii
â”‚   â”‚   â””â”€â”€ ..._CFT.nii
â”‚   â””â”€â”€ .../
â”‚
â”œâ”€â”€ PD_paired_FDG+CFT/
â”‚   â”œâ”€â”€ 18726/
â”‚   â”‚   â”œâ”€â”€ ..._FDG.nii
â”‚   â”‚   â””â”€â”€ ..._CFT.nii
â”‚   â””â”€â”€ .../
â”‚
â””â”€â”€ NC_unpaired_FDG+CFT/
    â”œâ”€â”€ FDG/
    â”‚   â”œâ”€â”€ ..._FDG.nii
    â”‚   â””â”€â”€ ...
    â””â”€â”€ CFT/
        â”œâ”€â”€ ..._CFT.nii
        â””â”€â”€ ...
```

## ğŸš€ ä½¿ç”¨æŒ‡å—

æ•´ä¸ªå·¥ä½œæµç¨‹åˆ†ä¸ºå››ä¸ªä¸»è¦é˜¶æ®µï¼šè®­ç»ƒCycleGAN -> ç”Ÿæˆä¼ªå›¾åƒ -> è®­ç»ƒåˆ†ç±»å™¨ -> æµ‹è¯•ã€‚

### é˜¶æ®µä¸€ï¼šè®­ç»ƒ CycleGAN

æ­¤å‘½ä»¤å°†å¯åŠ¨ CycleGAN çš„è®­ç»ƒè¿‡ç¨‹ã€‚æ‰€æœ‰æ—¥å¿—ã€æ¨¡å‹æƒé‡å’Œ TensorBoard æ–‡ä»¶å°†ä¿å­˜åœ¨ `./checkpoints/` ç›®å½•ä¸‹çš„ä¸€ä¸ªå¸¦æ—¶é—´æˆ³çš„æ–°æ–‡ä»¶å¤¹ä¸­ã€‚

```bash
python main.py --mode train --dataroot "./datasets" --epochs 200 --batch_size 1 --device "cuda:0"
```

**ç›‘æ§è®­ç»ƒè¿‡ç¨‹**:
è®­ç»ƒå¼€å§‹åï¼Œæ‰“å¼€ä¸€ä¸ª**æ–°çš„ç»ˆç«¯**ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨ TensorBoardï¼š
```bash
tensorboard --logdir=./checkpoints
```
ç„¶ååœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ `http://localhost:6006/`ã€‚

### é˜¶æ®µäºŒï¼šç”Ÿæˆç”¨äºåˆ†ç±»çš„ä¼ªå›¾åƒ

è®­ç»ƒå®Œ CycleGAN åï¼Œä½¿ç”¨æ­¤å‘½ä»¤åŠ è½½è®­ç»ƒå¥½çš„ç”Ÿæˆå™¨ï¼Œå°†æ‰€æœ‰æº FDG å›¾åƒè½¬æ¢ä¸ºä¼ª CFT å›¾åƒï¼Œå¹¶ä¿å­˜åœ¨ `./generated_images` ç›®å½•ä¸­ã€‚æ–‡ä»¶åå°†è‡ªåŠ¨åŒ…å« `NC` æˆ– `PD` æ ‡ç­¾ã€‚

```bash
python generate_fakes.py --dataroot "./datasets" --generated_dir "./generated_images" --load_epoch 200 --device "cuda:0"
```
- `--load_epoch`: æŒ‡å®šåŠ è½½å“ªä¸ªè½®æ¬¡ä¿å­˜çš„ç”Ÿæˆå™¨æƒé‡ã€‚

### é˜¶æ®µä¸‰ï¼šè®­ç»ƒåˆ†ç±»å™¨

ä½¿ç”¨ä¸Šä¸€æ­¥ç”Ÿæˆçš„å›¾åƒæ¥è®­ç»ƒ 3D ResNet åˆ†ç±»å™¨ã€‚æ‰€æœ‰ç›¸å…³æ–‡ä»¶å°†ä¿å­˜åœ¨ `./checkpoints_classifier/` ç›®å½•ä¸‹çš„æ–°æ–‡ä»¶å¤¹ä¸­ã€‚

```bash
python train_classifier.py --classifier_dataroot "./generated_images" --classifier_epochs 100 --batch_size 2 --device "cuda:0"
```

**ç›‘æ§åˆ†ç±»å™¨è®­ç»ƒ**:
æ‰“å¼€ä¸€ä¸ª**æ–°çš„ç»ˆç«¯**ï¼Œè¿è¡Œï¼š
```bash
tensorboard --logdir=./checkpoints_classifier
```

### é˜¶æ®µå››ï¼šè¿è¡Œæ¨ç† (æµ‹è¯•)

ä½¿ç”¨è®­ç»ƒå¥½çš„ç”Ÿæˆå™¨è½¬æ¢å•ä¸ªæˆ–å¤šä¸ªæµ‹è¯•å›¾åƒã€‚

1.  å°†å¾…æµ‹è¯•çš„ FDG `.nii` æ–‡ä»¶æ”¾å…¥ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼ˆä¾‹å¦‚ `./test_A`ï¼‰ã€‚
2.  è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
python main.py --mode test --dataroot "./test_A" --result_dir "./results" --load_epoch 200 --device "cuda:0"
```
- `--dataroot`: æŒ‡å‘æµ‹è¯•å›¾åƒæ‰€åœ¨çš„æ–‡ä»¶å¤¹ã€‚
- `--result_dir`: æŒ‡å®šè½¬æ¢åå›¾åƒçš„ä¿å­˜ä½ç½®ã€‚

## ğŸ“„ é¡¹ç›®ç»“æ„

```
.
â”œâ”€â”€ main.py                   # ä¸»å…¥å£: é€‰æ‹©è®­ç»ƒæˆ–æµ‹è¯•CycleGAN
â”œâ”€â”€ options.py                # ç®¡ç†æ‰€æœ‰å‘½ä»¤è¡Œå‚æ•°
â”œâ”€â”€ trainer.py                # CycleGAN è®­ç»ƒå™¨æ ¸å¿ƒé€»è¾‘
â”œâ”€â”€ tester.py                 # CycleGAN æµ‹è¯•/æ¨ç†é€»è¾‘
â”œâ”€â”€ dataset.py                # CycleGAN æ•°æ®é›†åŠ è½½å™¨ (å¤„ç†æ··åˆæ•°æ®)
|
â”œâ”€â”€ generate_fakes.py         # æ‰¹é‡ç”Ÿæˆä¼ªå›¾åƒçš„è„šæœ¬
â”œâ”€â”€ train_classifier.py       # åˆ†ç±»å™¨è®­ç»ƒæ ¸å¿ƒé€»è¾‘
â”œâ”€â”€ classifier_dataset.py     # åˆ†ç±»å™¨æ•°æ®é›†åŠ è½½å™¨
|
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ generator.py          # 3D U-Net ç”Ÿæˆå™¨
â”‚   â”œâ”€â”€ discriminator.py      # 3D PatchGAN åˆ¤åˆ«å™¨
â”‚   â””â”€â”€ classification.py     # 3D ResNet åˆ†ç±»å™¨
|
â”œâ”€â”€ datasets/                 # (éœ€è‡ªå»º) å­˜æ”¾åŸå§‹ .nii æ•°æ®
â”œâ”€â”€ checkpoints/              # (è‡ªåŠ¨ç”Ÿæˆ) ä¿å­˜CycleGANè®­ç»ƒç»“æœ
â”œâ”€â”€ checkpoints_classifier/   # (è‡ªåŠ¨ç”Ÿæˆ) ä¿å­˜åˆ†ç±»å™¨è®­ç»ƒç»“æœ
â””â”€â”€ generated_images/         # (è‡ªåŠ¨ç”Ÿæˆ) ä¿å­˜ç”Ÿæˆçš„ä¼ªå›¾åƒ
```

## ğŸ¤ è‡´è°¢

æœ¬é¡¹ç›®çš„ CycleGAN å®ç°å‚è€ƒäº† [Jun-Yan Zhu](https://junyanz.github.io/) ç­‰äººå‘è¡¨çš„åŸå§‹è®ºæ–‡ï¼š
> [*Unpaired Image-to-Image Translation using Cycle-Consistent Adversarial Networks*](https://arxiv.org/abs/1703.10593)

## ğŸ“œ è®¸å¯è¯

(æ‚¨å¯ä»¥åœ¨æ­¤å¤„æ·»åŠ æ‚¨é€‰æ‹©çš„è®¸å¯è¯
